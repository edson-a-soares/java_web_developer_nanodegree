pipeline {

    agent any

    environment {
        PROJECT_REPOSITORY_DIRECTORY = "eCommerce"
        APPLICATION_CONTEXT = "$WORKSPACE/$PROJECT_REPOSITORY_DIRECTORY"
    }

    options {
        skipDefaultCheckout()
        skipStagesAfterUnstable()
    }

    stages {

        stage ('SCM Checkout') {

            steps {
                checkout scm
            }

        }

        stage ('Build') {

            steps {

                script {
                    docker.image("maven:3.6.3-openjdk-8-slim").inside() {
                        sh 'cd $APPLICATION_CONTEXT'
                        sh 'mvn -B -DskipTests clean package'
                    }
                }

            }

        }

        stage ('Test') {

            when {
                anyOf {
                    changeset "$APPLICATION_CONTEXT/**/*"
                }
            }

            steps {

                script {
                    docker.image("maven:3.6.3-openjdk-8-slim").inside() {
                        dir("$APPLICATION_CONTEXT") {
                            sh 'mvn test'
                        }
                    }
                }

                post {
                    always {
                        junit 'target/surefire-reports/*.xml'
                    }
                }

            }

        }

        stage ('Deploy') {

            when {
                anyOf {
                    changeset "${APPLICATION_DIRECTORY}/**/*"
                }
            }

            steps {
                script {
                    sh 'echo $APPLICATION_DIRECTORY'
                }
            }

        }

    }   // Stages

}       // Pipeline
